/**
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; under version 2
 * of the License (non-upgradable).
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 *
 * Copyright (c) 2014 (original work) Open Assessment Technologies SA (under the project TAO-PRODUCT);
 * 
 * 
 */

//@see http://forge.taotesting.com/projects/tao/wiki/Front_js
define('taoDelivery/controller/routes',[],function(){
    

    return {
        'Delivery': {
            'deps' : 'controller/deliveryAssembly',
            'actions' : {
                'getSectionActions' : 'controller/main/actions',
                'getSectionTrees' : 'controller/main/trees',
	            'excludeTesttaker' : 'controller/testtaker'
            }
        },
        'Compilation' : {
            'actions' : {
                'index' : 'controller/compilation/compiling'
	        }
        }
    };
});

/*  
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; under version 2
 * of the License (non-upgradable).
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 * 
 * Copyright (c) 2008-2010 (original work) Deutsche Institut für Internationale Pädagogische Forschung (under the project TAO-TRANSFER);
 *               2009-2012 (update and modification) Public Research Centre Henri Tudor (under the project TAO-SUSTAIN & TAO-DEV);
 * 
 */
define('taoDelivery/controller/compilation/compiling',['module' ,'jquery', 'i18n', 'context', 'helpers', 'uiBootstrap'], function(module, $, __, context, helpers, uiBootstrap){

    function initCompilation(uri, clazz){
        $("#initCompilation").hide();
        $('#generatingProcess_info').show();
        $('#generatingProcess_feedback').empty().hide();
        $("#progressbar").empty();
        $('.main-container').append('<div id="compilationReport"></div>');
        
        $.ajax({
	        url: helpers._url('compile', 'Compilation', 'taoDelivery'),
	        type: "POST",
	        dataType: "text",
	        data: {uri : uri, classUri: clazz},
	        success: function (data, textStatus, jqXHR){
	            $('#generatingProcess_info').hide();
	            $('#compilationReport').html(data);
	        },
	        error: function (jqXHR, textStatus, errorThrown) {
	        	finalMessage(errorThrown);
	        }
        });
    }

    function finalMessage(msg, imageFile){
        $('<img/>').attr("src", context.root_url + 'taoDelivery/views/img/' + imageFile).appendTo($("#progressbar"));
        $("#progressbar").append(msg);

        //reinitiate the values and suggest recompilation
        $('#postCompilation').show();
        $("#initCompilation").html( __("Recompile the delivery") );
    }
    
    return {
        start : function(){
            
            var conf = module.config();
            
            $('#generatingProcess_info').hide();
            $('.back').click(function(e){
                e.preventDefault();
                helpers._load(helpers.getMainContainerSelector(), context.root_url + 'taoDelivery/Delivery/editDelivery/', {
                    uri: conf.uri,
                    classUri:  conf.classUri
                });
            });
            $('#compiler').click(function(e){
                e.preventDefault();
                initCompilation(conf.uri, conf.classUri);
            });
        }
    };
});
/**
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; under version 2
 * of the License (non-upgradable).
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 *
 * Copyright (c) 2013 (original work) Open Assessment Technologies SA (under the project TAO-PRODUCT);
 *
 *
 */
define('taoDelivery/controller/deliveryAssembly',['jquery', 'i18n', 'helpers', 'uiBootstrap', 'module'], function ($, __, helpers, uiBootstrap, module) {

        var $tabs = uiBootstrap.tabs;
        var templatesIndex = helpers.getTabIndexByName('manage_delivery_templates');
        
        return {
            start : function(){
                var conf = module.config();
                $tabs.each(function(i) {
                	if (i === templatesIndex) {
                		$(this).css({border: '3px'});
                	}
                })
                if(conf.action !== 'authoring'){
                    //$tabs.tabs('remove', templatesIndex);
                }
                
                if(conf.reload){
                    uiBootstrap.initTrees();
                }
                if(conf.message){
                    helpers.createMessage(conf.message);
                }
                
                $('#saver-status').click(function(e){
                	var status = $('input[name="status"]:checked').val();
                	var uri = $('input[name="assemblyUri"]').val();
                    $.ajax({
            	        url: helpers._url('setStatus', 'Delivery', 'taoDelivery'),
            	        type: "POST",
            	        dataType: "text",
            	        data: {uri : uri, status: status},
            	        success: function (data, textStatus, jqXHR){
                        	//$('#active-inactive').modal('close');
                        	helpers.createMessage("Status saved");
                        	uiBootstrap.initTrees();
            	        },
            	        error: function (jqXHR, textStatus, errorThrown) {
                        	console.log('Error occured: ' + errorThrown);
            	        }
                    });
            	});
            }
        };
});



(function(t,e){if(typeof exports=="object")module.exports=e();else if(typeof define=="function"&&define.amd)define('spin',e);else t.Spinner=e()})(this,function(){var t=["webkit","Moz","ms","O"],e={},i;function o(t,e){var i=document.createElement(t||"div"),o;for(o in e)i[o]=e[o];return i}function n(t){for(var e=1,i=arguments.length;e<i;e++)t.appendChild(arguments[e]);return t}var r=function(){var t=o("style",{type:"text/css"});n(document.getElementsByTagName("head")[0],t);return t.sheet||t.styleSheet}();function s(t,o,n,s){var a=["opacity",o,~~(t*100),n,s].join("-"),f=.01+n/s*100,l=Math.max(1-(1-t)/o*(100-f),t),u=i.substring(0,i.indexOf("Animation")).toLowerCase(),d=u&&"-"+u+"-"||"";if(!e[a]){r.insertRule("@"+d+"keyframes "+a+"{"+"0%{opacity:"+l+"}"+f+"%{opacity:"+t+"}"+(f+.01)+"%{opacity:1}"+(f+o)%100+"%{opacity:"+t+"}"+"100%{opacity:"+l+"}"+"}",r.cssRules.length);e[a]=1}return a}function a(e,i){var o=e.style,n,r;i=i.charAt(0).toUpperCase()+i.slice(1);for(r=0;r<t.length;r++){n=t[r]+i;if(o[n]!==undefined)return n}if(o[i]!==undefined)return i}function f(t,e){for(var i in e)t.style[a(t,i)||i]=e[i];return t}function l(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var o in i)if(t[o]===undefined)t[o]=i[o]}return t}function u(t){var e={x:t.offsetLeft,y:t.offsetTop};while(t=t.offsetParent)e.x+=t.offsetLeft,e.y+=t.offsetTop;return e}function d(t,e){return typeof t=="string"?t:t[e%t.length]}var p={lines:12,length:7,width:5,radius:10,rotate:0,corners:1,color:"#000",direction:1,speed:1,trail:100,opacity:1/4,fps:20,zIndex:2e9,className:"spinner",top:"auto",left:"auto",position:"relative"};function c(t){if(typeof this=="undefined")return new c(t);this.opts=l(t||{},c.defaults,p)}c.defaults={};l(c.prototype,{spin:function(t){this.stop();var e=this,n=e.opts,r=e.el=f(o(0,{className:n.className}),{position:n.position,width:0,zIndex:n.zIndex}),s=n.radius+n.length+n.width,a,l;if(t){t.insertBefore(r,t.firstChild||null);l=u(t);a=u(r);f(r,{left:(n.left=="auto"?l.x-a.x+(t.offsetWidth>>1):parseInt(n.left,10)+s)+"px",top:(n.top=="auto"?l.y-a.y+(t.offsetHeight>>1):parseInt(n.top,10)+s)+"px"})}r.setAttribute("role","progressbar");e.lines(r,e.opts);if(!i){var d=0,p=(n.lines-1)*(1-n.direction)/2,c,h=n.fps,m=h/n.speed,y=(1-n.opacity)/(m*n.trail/100),g=m/n.lines;(function v(){d++;for(var t=0;t<n.lines;t++){c=Math.max(1-(d+(n.lines-t)*g)%m*y,n.opacity);e.opacity(r,t*n.direction+p,c,n)}e.timeout=e.el&&setTimeout(v,~~(1e3/h))})()}return e},stop:function(){var t=this.el;if(t){clearTimeout(this.timeout);if(t.parentNode)t.parentNode.removeChild(t);this.el=undefined}return this},lines:function(t,e){var r=0,a=(e.lines-1)*(1-e.direction)/2,l;function u(t,i){return f(o(),{position:"absolute",width:e.length+e.width+"px",height:e.width+"px",background:t,boxShadow:i,transformOrigin:"left",transform:"rotate("+~~(360/e.lines*r+e.rotate)+"deg) translate("+e.radius+"px"+",0)",borderRadius:(e.corners*e.width>>1)+"px"})}for(;r<e.lines;r++){l=f(o(),{position:"absolute",top:1+~(e.width/2)+"px",transform:e.hwaccel?"translate3d(0,0,0)":"",opacity:e.opacity,animation:i&&s(e.opacity,e.trail,a+r*e.direction,e.lines)+" "+1/e.speed+"s linear infinite"});if(e.shadow)n(l,f(u("#000","0 0 4px "+"#000"),{top:2+"px"}));n(t,n(l,u(d(e.color,r),"0 0 1px rgba(0,0,0,.1)")))}return t},opacity:function(t,e,i){if(e<t.childNodes.length)t.childNodes[e].style.opacity=i}});function h(){function t(t,e){return o("<"+t+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',e)}r.addRule(".spin-vml","behavior:url(#default#VML)");c.prototype.lines=function(e,i){var o=i.length+i.width,r=2*o;function s(){return f(t("group",{coordsize:r+" "+r,coordorigin:-o+" "+-o}),{width:r,height:r})}var a=-(i.width+i.length)*2+"px",l=f(s(),{position:"absolute",top:a,left:a}),u;function p(e,r,a){n(l,n(f(s(),{rotation:360/i.lines*e+"deg",left:~~r}),n(f(t("roundrect",{arcsize:i.corners}),{width:o,height:i.width,left:i.radius,top:-i.width>>1,filter:a}),t("fill",{color:d(i.color,e),opacity:i.opacity}),t("stroke",{opacity:0}))))}if(i.shadow)for(u=1;u<=i.lines;u++)p(u,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(u=1;u<=i.lines;u++)p(u);return n(e,l)};c.prototype.opacity=function(t,e,i,o){var n=t.firstChild;o=o.shadow&&o.lines||0;if(n&&e+o<n.childNodes.length){n=n.childNodes[e+o];n=n&&n.firstChild;n=n&&n.firstChild;if(n)n.opacity=i}}}var m=f(o("group"),{behavior:"url(#default#VML)"});if(!a(m,"transform")&&m.adj)h();else i=a(m,"animation");return c});
/**
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; under version 2
 * of the License (non-upgradable).
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 *
 * Copyright (c) 2013 (original work) Open Assessment Technologies SA (under the project TAO-PRODUCT);
 *
 *
 */
define('taoDelivery/controller/runtime/deliveryExecution',['jquery', 'iframeResizer', 'spin'], function($, iframeResizer, Spinner){
    
    function loading(reverse) {
        if($('#overlay').length === 0){
            
            $('<div id="overlay"></div>').appendTo(document.body);
            $('<div id="loading"><div></div></div>').appendTo(document.body);
        }

        var opts = {
                lines: 11, // The number of lines to draw
                length: 21, // The length of each line
                width: 8, // The line thickness
                radius: 36, // The radius of the inner circle
                corners: 1, // Corner roundness (0..1)
                rotate: 0, // The rotation offset
                direction: (reverse === true) ? -1 : 1, // 1: clockwise, -1: counterclockwise
                color: '#888', // #rgb or #rrggbb or array of colors
                speed: 1.5, // Rounds per second
                trail: 60, // Afterglow percentage
                shadow: false, // Whether to render a shadow
                hwaccel: false, // Whether to use hardware acceleration
                className: 'spinner', // The CSS class to assign to the spinner
                zIndex: 2e9, // The z-index (defaults to 2000000000)
        };
        new Spinner(opts).spin($('#loading > div').get(0));
    }
    
    function unloading() {
        setTimeout(function(){
            $('#loading').fadeOut(300, function(){
                $(this).remove();
                $('#overlay').remove();
            });
        }, 300);
    }
    
    function resizeMainFrame() {
        var $frame = $('#iframeDeliveryExec');
        var windowHeight = $(window).height();
        var controlHeight = 0;
        var $control = $('#control');
        
        if ($control.length === 1) {
            controlHeight = $control.outerHeight(true);
        }
        
        var newHeight = windowHeight - controlHeight;
        
        if (navigator.userAgent.match(/(iPad|iPhone|iPod)/g) ? true : false == true) {
            newHeight -= 20;
        }
        
        $frame.css('height', newHeight + 'px');
    }
    
    return {
        start: function(options){
            
            var $frame = $('#iframeDeliveryExec');
            $('#tools').css('height', 'auto');
            
            var serviceApi = options.serviceApi;

            serviceApi.onFinish(function() {
                $.ajax({
                    url : options.finishDeliveryExecution,
                    data : {
                        'deliveryExecution' : options.deliveryExecution
                    },
                    type : 'post',
                    dataType : 'json',
                    success : function(data) {
                        window.location = data.destination;
                    }
                });
            });
            
            $(document)
                .on('loading', function(e, reverse){
                    loading(reverse);
                })
                .on('unloading', function(){
                    unloading();
                })
                .on('shutdown-com', function(){
                    //use when we want to stop all exchange between frames
                    $(document).off('heightchange');
                    $frame.off('load.eventHeight')
                           .off('load.cors');
                });
            
            serviceApi.loadInto($frame.get(0));
            
            $(window).bind('resize', function() {
                resizeMainFrame();
            });
            
            resizeMainFrame();
        }
    };
});
/**
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; under version 2
 * of the License (non-upgradable).
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 *
 * Copyright (c) 2013 (original work) Open Assessment Technologies SA (under the project TAO-PRODUCT);
 *
 *
 */
(function(){
    //the url of the app config is set into the data-config attr of the loader.
    var appConfig = document.getElementById('amd-loader').getAttribute('data-config');
    require([appConfig], function(){
   
        require(['jquery'], function($){
            $('ul li').mouseover(function() {
                $("a .actionsBox .button", this).addClass("buttonSelected");
            });
            $('ul li').mouseleave(function() {
                $("a .actionsBox .button", this).removeClass("buttonSelected");
            });
        });
    });

}());

define("taoDelivery/controller/runtime/index", function(){});

/**
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; under version 2
 * of the License (non-upgradable).
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 *
 * Copyright (c) 2013 (original work) Open Assessment Technologies SA (under the project TAO-PRODUCT);
 *
 *
 */
define('taoDelivery/controller/testtaker',['jquery', 'i18n', 'helpers', 'uiBootstrap', 'module'], function ($, __, helpers, uiBootstrap, module) {

	function switchList() {
		var current = $(this).parent().attr('id');
		if (current == 'excludedList') {
			var target = $('#assignedList'); 
		} else if (current == 'assignedList') {
			var target = $('#excludedList');
		}
		if (typeof target != 'undefined') {
			target.append(this);
			this.scrollIntoView();
		}
	}
	
	var $search = $('#tt-filter');
    var $list   = $('#assignedList');
    var timeout;
    
    var liveSearch = function(){
        var pattern = $search.val();
        clearTimeout(timeout);
        timeout = setTimeout(function(){
        	filterList(new RegExp(pattern), $list);
        }, 300);
    };
    
    var filterList = function(regex, list) {
    	list.children().each(function(index, element) {
    		if ($(element).text().match(regex) == null) {
    			$(element).hide();
    		} else {
    			$(element).show();
    		}
    	})
    }
	
    return {
        start : function(){
	        $('#save-tt').click(function() {
	        	var excluded = [];
	        	$('#excludedList > li').each(function(index) {
	        		excluded.push($(this).data('uri'));
	        	});
	        	var assemblyUri = $('input[name="assemblyUri"]').val();
	        	$.ajax({
	        		url: helpers._url('saveExcluded', 'Delivery', 'taoDelivery'),
					type: "POST",
					data: {
						uri: assemblyUri,
						excluded: JSON.stringify(excluded)
					},
					dataType: 'json',
					success: function(response) {
						if (response.saved) {
							helpers.createInfoMessage(__('Selection saved successfully'));
							helpers._load(
								helpers.getMainContainerSelector()
								,helpers._url('editDelivery', 'Delivery', 'taoDelivery')
								,{uri: assemblyUri}
							);
						}
					},
					complete: function() {
						helpers.loaded();
					}
				});
	        })
        	$('#assignedList > li').click(switchList);
        	$('#excludedList > li').click(switchList);
        	
        	$('#close-tt').click(function() {
        		$('#testtaker-form').modal('close');
        	});
        	
                
            //trigger the search on keyp and on the magnifer button click
            $search.keyup(liveSearch).siblings('.ctrl').click(liveSearch);
        	
        }
    };
});



